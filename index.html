<!DOCTYPE html>
<html>
<head>
  <title>CRMmap</title>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAd-TysVPwn4y8dPtbdZEWKV9fzBP-ztC4&callback=initMap" async defer></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }
    #form {
      padding: 10px;
      background: #f4f4f4;
      border-bottom: 1px solid #ccc;
    }
    #form input, #form button {
      margin: 5px;
      padding: 5px;
    }
    #map {
      height: 70vh;
      width: 100%;
    }
    #project-list {
      padding: 10px;
      background: #fff;
    }
    #project-list table {
      width: 100%;
      border-collapse: collapse;
    }
    #project-list th, #project-list td {
      border: 1px solid #ccc;
      padding: 8px;
    }
  </style>
</head>
<body>
  <div id="form">
    <input id="client" placeholder="Client">
    <input id="projectType" placeholder="Project Type">
    <input id="status" placeholder="Status">
    <input id="plusCode" placeholder="Plus Code">
    <button onclick="addProject()">Add Project</button>
    <button onclick="resetProjects()">Reset Projects</button>
  </div>
  <div id="map"></div>
  <div id="project-list">
    <h3>Project List</h3>
    <table>
      <thead>
        <tr><th>Client</th><th>Type</th><th>Status</th><th>Plus Code</th></tr>
      </thead>
      <tbody id="projectTableBody"></tbody>
    </table>
  </div>
  <script>
    let map;
    let projects = [];
    const markers = [];
    const geocoder = new google.maps.Geocoder();

    const defaultProjects = [
      { client: "Shadforth", projectType: "Subdivision", status: "Live", plusCode: "PW7R+W73 Joyner, Queensland" },
      { client: "Sunshine Coast Civil", projectType: "Subdivision", status: "Live", plusCode: "MXF9+PJX Brendale, Queensland" },
      { client: "Hall Contracting", projectType: "Subdivision", status: "Live", plusCode: "VXMH+9RM Morayfield, Queensland" },
      { client: "SGQ", projectType: "Bulk Earthworks", status: "Live", plusCode: "M28X+4H Narangba, Queensland" },
      { client: "Bellwether Contractors", projectType: "Rail", status: "Tendering", plusCode: "R2V6+F4 Beerwah, Queensland" },
      { client: "Shadforth", projectType: "Subdivision", status: "Live", plusCode: "V2VC+V9W Baringa, Queensland" },
      { client: "Hutchinson Builders", projectType: "Commercial", status: "Live", plusCode: "W2J6+86 Sippy Downs, Queensland" },
      { client: "Shadforth", projectType: "Subdivision", status: "Live", plusCode: "QX8H+GPW Palmview, Queensland" },
      { client: "Stockland", projectType: "Bulk Earthworks", status: "Live", plusCode: "RW94+HCW Aura, Queensland" },
      { client: "Schulz", projectType: "Rural Dam", status: "Pending", plusCode: "9VHH+G8K Eudlo, Queensland" },
      { client: "Bellwether Contractors", projectType: "Bulk Earthworks", status: "Live", plusCode: "RWX3+R2 Aura, Queensland" },
      { client: "Mooloolah Contracting", projectType: "Rural Dam", status: "Live", plusCode: "8VJ9+PW Landsborough, Queensland" },
      { client: "Dynamic Excavations", projectType: "Commercial", status: "Pending", plusCode: "R2MH+Q2 Caloundra West, Queensland" },
      { client: "Midson", projectType: "Commercial", status: "Pending", plusCode: "MX8F+46 Maroochydore, Queensland" }
    ];

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 10,
        center: { lat: -27.4, lng: 152.9 }
      });
      loadProjects();
    }

    function loadProjects() {
      const saved = localStorage.getItem("projects");
      projects = saved ? JSON.parse(saved) : [...defaultProjects];
      if (!saved) localStorage.setItem("projects", JSON.stringify(projects));
      renderProjects();
    }

    function renderProjects() {
      document.getElementById("projectTableBody").innerHTML = "";
      markers.forEach(m => m.setMap(null));
      markers.length = 0;

      projects.forEach(proj => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${proj.client}</td><td>${proj.projectType}</td><td>${proj.status}</td><td>${proj.plusCode}</td>`;
        document.getElementById("projectTableBody").appendChild(row);

        geocoder.geocode({ address: proj.plusCode }, (results, status) => {
          if (status === "OK") {
            const marker = new google.maps.Marker({
              map,
              position: results[0].geometry.location,
              title: proj.client
            });
            const info = new google.maps.InfoWindow({
              content: `<b>${proj.client}</b><br>${proj.projectType} - ${proj.status}`
            });
            marker.addListener("click", () => info.open(map, marker));
            markers.push(marker);
          } else {
            console.warn("Failed to geocode:", proj.plusCode);
          }
        });
      });
    }

    function addProject() {
      const client = document.getElementById("client").value.trim();
      const projectType = document.getElementById("projectType").value.trim();
      const status = document.getElementById("status").value.trim();
      const plusCode = document.getElementById("plusCode").value.trim();

      if (!client || !projectType || !status || !plusCode) return alert("All fields are required.");

      const newProj = { client, projectType, status, plusCode };
      projects.push(newProj);
      localStorage.setItem("projects", JSON.stringify(projects));
      renderProjects();

      document.getElementById("client").value = "";
      document.getElementById("projectType").value = "";
      document.getElementById("status").value = "";
      document.getElementById("plusCode").value = "";
    }

    function resetProjects() {
      if (confirm("This will erase all custom entries. Proceed?")) {
        localStorage.removeItem("projects");
        location.reload();
      }
    }

    window.initMap = initMap;
  </script>
</body>
</html>
